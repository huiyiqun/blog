<!DOCTYPE html>
<html lang="zh">
<head>
        <meta charset="utf-8" />
        <title>Notepad - Android</title>
        <link rel="stylesheet" href="../theme/css/main.css" />
        <link href="/feed.xml" type="application/atom+xml" rel="alternate" title="Notepad Atom Feed" />

        <!--[if IE]>
            <script src="https://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="../">Notepad </a></h1>
                <nav><ul>
                    <li class="active"><a href="../category/android.html">Android</a></li>
                    <li><a href="../category/multimedia.html">Multimedia</a></li>
                    <li><a href="../category/ops.html">Ops</a></li>
                    <li><a href="../category/python.html">Python</a></li>
                </ul></nav>
        </header><!-- /#banner -->

            <aside id="featured" class="body">
                <article>
                    <h1 class="entry-title"><a href="../2015/04/05/chroot-to-archlinux-arm-on-galaxy-s4.html">在三星Galaxy S4上chroot方式安装Archlinux Arm</a></h1>
<footer class="post-info">
        <abbr class="published" title="2015-04-05T12:20:00+08:00">
                Published: Sun 05 April 2015
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="../author/hui-yiqun.html">Hui Yiqun</a>
        </address>
<p>In <a href="../category/android.html">Android</a>.</p>

</footer><!-- /.post-info --><h1>前言</h1>
<p>入手 Galaxy S4 已经几个月了，我手里这款是 I9508，也就是移动3G定制版，除了制式以外其他
硬件和 I9505（也就是 Galaxy S4 国际版）是一样的。因此搭了 I9505 的东风，装上了
<a href="http://forum.xda-developers.com/galaxy-s4/i9505-orig-develop/rom-cyanogenmod-12-t2943934">cm12</a>，
作者最近还编译了
<a href="http://forum.xda-developers.com/galaxy-s4/i9505-orig-develop/exclusive-antaresone-alucard24-s-t3066696">cm12.1</a>，
等 Xposed 可以用到 Android 5.1 之后就可以装上了。</p>
<h1>硬件</h1>
<p>进入正题，首先看一下硬件的情况：</p>
<div class="highlight"><pre><span></span>(notebook)$ adb shell df
Filesystem               Size     Used     Free   Blksize
/dev                   905.5M    48.0K   905.5M   4096
/sys/fs/cgroup         905.5M    12.0K   905.5M   4096
/mnt/asec              905.5M     0.0K   905.5M   4096
/mnt/obb               905.5M     0.0K   905.5M   4096
/system                  2.7G   970.1M     1.7G   4096
/firmware               86.0M    11.5M    74.4M   16384
/firmware-mdm           86.0M    49.8M    36.2M   16384
/efs                    13.4M     4.2M     9.2M   4096
/cache                   2.0G   448.4M     1.6G   4096
/data                    9.1G     6.0G     3.1G   4096
/mnt/shell/emulated      9.1G     6.0G     3.1G   4096
/mnt/ntfs              905.5M     0.0K   905.5M   4096
</pre></div>


<div class="highlight"><pre><span></span>(notebook)$ adb shell cat /proc/cpuinfo
Processor   : ARMv7 Processor rev 0 (v7l)
processor   : 0
BogoMIPS    : 13.53

processor   : 1
BogoMIPS    : 13.53

processor   : 2
BogoMIPS    : 13.53

processor   : 3
BogoMIPS    : 13.53

Features    : swp half thumb fastmult vfp edsp neon vfpv3 tls vfpv4 idiva idivt vfpd32 
CPU implementer : 0x51
CPU architecture: 7
CPU variant : 0x1
CPU part    : 0x06f
CPU revision    : 0

Hardware    : SAMSUNG JF
Revision    : 000b
Serial      : 0000b74100006515
</pre></div>


<div class="highlight"><pre><span></span>(notebook)$ adb shell uname -m
armv7l
</pre></div>


<h1>准备分区</h1>
<p><code>/data/</code> 容量实在是大得不行，我就决定直接把系统装到 <code>/data/</code> 里了。</p>
<p>手机当然要 root，否则<code>/data/</code>目录不可读。</p>
<div class="highlight"><pre><span></span>(notebook)$ adb shell
$ su
#
</pre></div>


<p>我给<code>archlinux</code>开了1G的空间，可能有点不太够。</p>
<div class="highlight"><pre><span></span># mkdir -p /data/linux
# busybox dd if=/dev/zero of=/data/linux/archlinux.img bs=1M count=0 seek=1024
# mkfs.ext2 -F /data/linux/archlinux.img
# mkdir -p /data/mnt/archlinux
# mount /data/linux/archlinux.img /data/mnt/archlinux
</pre></div>


<h1>系统文件</h1>
<p>这样空间都准备好了，接下来把<code>Archlinux Arm</code>的文件系统下载下来，本来是想直接在
<code>Android</code>里面用<code>wget</code>下，不过报下面的错：</p>
<div class="highlight"><pre><span></span><span class="n">error</span><span class="o">:</span> <span class="n">only</span> <span class="n">position</span> <span class="n">independent</span> <span class="n">executables</span> <span class="o">(</span><span class="n">PIE</span><span class="o">)</span> <span class="n">are</span> <span class="n">supported</span><span class="o">.</span>
</pre></div>


<p>Google 了一下，好像是ndk的原因，<code>busybox</code>里的<code>wget</code>也有另外一个问题，貌似不能正确地
把域名解析为IP地址。</p>
<p>因此在我的笔记本里下载文件，再用adb传到手机里。</p>
<p>用的是<code>Tsinghua TUNA</code>的镜像，有<code>IPv4</code>和<code>IPv6</code>的接入。</p>
<div class="highlight"><pre><span></span>(notebook)$ wget http://mirrors.tuna.tsinghua.edu.cn/archlinuxarm/os/ArchLinuxARM-armv7-latest.tar.gz
(notebook)$ adb push ArchLinux-armv7-latest.tar.gz /sdcard/
</pre></div>


<p>这里下的是<code>armv7</code>的版本，<a href="http://mirrors.tuna.tsinghua.edu.cn/archlinuxarm/os/">镜像站</a>里也有别的版本，
不过别的我也不认识，不知道有什么区别，总之<code>armv7</code>这个版本是可以用。</p>
<div class="highlight"><pre><span></span># cd /data/mnt/archlinux
# tar xfz /sdcard/ArchLinuxARM-armv7-latest.tar.gz
</pre></div>


<p>大概是因为CPU的原因，速度非常慢。在我电脑上解压这个文件大概几十秒，在我手机上用了有快两小时吧。23333</p>
<h1>chroot</h1>
<p>解压好之后就可以开始正式<code>chroot</code>了。</p>
<div class="highlight"><pre><span></span># mount -o bind /sys /data/mnt/archlinux/sys
# mount -o bind /proc /data/mnt/archlinux/proc
# mount -o bind /dev /data/mnt/archlinux/dev
# mount -t devpts devpts /data/mnt/archlinux/dev/pts
# chroot /data/mnt/archlinux su -
</pre></div>


<h1>fix</h1>
<p>此后就已经在<code>Archlinux</code>里了，不过还要处理几个问题：</p>
<ul>
<li>环境变量</li>
</ul>
<p>此时的<code>$PATH</code>等环境变量还是 Android 里的，导入 Archlinux 的环境变量</p>
<div class="highlight"><pre><span></span>. /etc/profile
</pre></div>


<ul>
<li><code>ld</code>报错</li>
</ul>
<div class="highlight"><pre><span></span><span class="n">ERROR</span><span class="o">:</span> <span class="n">ld</span><span class="o">.</span><span class="na">so</span><span class="o">:</span> <span class="n">object</span> <span class="s1">&#39;libsigchain.so&#39;</span> <span class="n">from</span> <span class="n">LD_PRELOAD</span> <span class="n">cannot</span> <span class="n">be</span> <span class="n">preloaded</span><span class="o">:</span> <span class="n">ignored</span><span class="o">.</span>
</pre></div>


<p>好像没什么影响，就是看着很烦。</p>
<div class="highlight"><pre><span></span>unset LD_PRELOAD
</pre></div>


<ul>
<li>不能访问网络</li>
</ul>
<p>参照<a href="http://archlinuxarm.org/forum/viewtopic.php?f=9&amp;t=4611">这个页面</a>，在<code>/etc/group</code>
中加入如下内容：</p>
<div class="highlight"><pre><span></span><span class="n">inet</span><span class="o">:</span><span class="n">x</span><span class="o">:</span><span class="mi">3003</span><span class="o">:</span><span class="n">root</span>
<span class="n">net_raw</span><span class="o">:</span><span class="n">x</span><span class="o">:</span><span class="mi">3004</span><span class="o">:</span><span class="n">root</span>
</pre></div><p>There are <a href="../2015/04/05/chroot-to-archlinux-arm-on-galaxy-s4.html#disqus_thread">comments</a>.</p>                </article>
            </aside><!-- /#featured -->
        <section id="extras" class="body">
                <div class="blogroll">
                        <h2>links</h2>
                        <ul>
                            <li><a href="https://tuna.moe/">TUNA</a></li>
                        </ul>
                </div><!-- /.blogroll -->
                <div class="social">
                        <h2>social</h2>
                        <ul>
                            <li><a href="/feed.xml" type="application/atom+xml" rel="alternate">atom feed</a></li>

                            <li><a href="https://github.com/huiyiqun">Github</a></li>
                            <li><a href="https://stackoverflow.com/users/2825773/given92">Stack Overflow</a></li>
                            <li><a href="https://plus.google.com/u/0/107187513671494024284">Google+</a></li>
                            <li><a href="https://telegram.me/huiyiqun">Telegram</a></li>
                        </ul>
                </div><!-- /.social -->
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->

                <p>The theme is by <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

    <script type="text/javascript">
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-89649249-1', 'auto');
    ga('send', 'pageview');
    </script>
<script type="text/javascript">
    var disqus_shortname = 'huiyiqun';
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = 'https://' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
</body>
</html>