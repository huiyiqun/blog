
<!DOCTYPE html>
<html lang="zh">
<head>
  <link href='//fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,700,400italic' rel='stylesheet' type='text/css'>

    <link rel="stylesheet" type="text/css" href="../../../theme/stylesheet/style.min.css">

  <link rel="stylesheet" type="text/css" href="../../../theme/pygments/default.min.css">
  <link rel="stylesheet" type="text/css" href="../../../theme/font-awesome/css/font-awesome.min.css">


    <link href="https://blog.huiyiqun.me/feed.xml" type="application/atom+xml" rel="alternate" title="Notepad Atom">



  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="HandheldFriendly" content="True" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="robots" content="" />

    <!-- Chrome, Firefox OS and Opera -->
    <meta name="theme-color" content="white">
    <!-- Windows Phone -->
    <meta name="msapplication-navbutton-color" content="white">
    <!-- iOS Safari -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

<meta name="author" content="Hui Yiqun" />
<meta name="description" content="前言 有一年多没有写东西了 ， 期间还是做了不少事情 ， 但是因为博 (zi) 客 (ji) 有 (te) 点 (bie) 丑 (lan)， 什么都没有写 。 很多东西花了很多时间去学和折腾 ， 回头要用到的时候又需要重新去 翻文档 ， 实在是浪费时间 ， 于是决定把博客续上 。 之所以会需要装虚拟机 ， 是因为 TUNA 最近又招了不少萌新 ， 萌新们可能需要一台 UNIX 的设备来瞎折腾 ， 另外协会内部偶尔需要交换 slide 或者活动视频 ， 大鹰主席又觉得通过 “ 网盘 ” 交换文件实在太羞耻 ， 因为我之前折腾过一下 KVM， 因而让我部署一台 Debian 的虚拟机 。 本来是一件简单的重复劳动 ， 但是基于以下理由 ： 萌新可能把机器弄坏或者机器需要搬家 以后会长可能会让我装第二个机器 好久没折腾了感觉皮子有点紧 ~~ 决定用 ansible 自动安装 。 整个过程花了大概两天左右 ， 其实 ansible 和 libvirt …" />
<meta name="keywords" content="">
<meta property="og:site_name" content="Notepad"/>
<meta property="og:title" content="使用libvirt和preseed自动部署运行于KVM上的Debian虚拟机"/>
<meta property="og:description" content="前言 有一年多没有写东西了 ， 期间还是做了不少事情 ， 但是因为博 (zi) 客 (ji) 有 (te) 点 (bie) 丑 (lan)， 什么都没有写 。 很多东西花了很多时间去学和折腾 ， 回头要用到的时候又需要重新去 翻文档 ， 实在是浪费时间 ， 于是决定把博客续上 。 之所以会需要装虚拟机 ， 是因为 TUNA 最近又招了不少萌新 ， 萌新们可能需要一台 UNIX 的设备来瞎折腾 ， 另外协会内部偶尔需要交换 slide 或者活动视频 ， 大鹰主席又觉得通过 “ 网盘 ” 交换文件实在太羞耻 ， 因为我之前折腾过一下 KVM， 因而让我部署一台 Debian 的虚拟机 。 本来是一件简单的重复劳动 ， 但是基于以下理由 ： 萌新可能把机器弄坏或者机器需要搬家 以后会长可能会让我装第二个机器 好久没折腾了感觉皮子有点紧 ~~ 决定用 ansible 自动安装 。 整个过程花了大概两天左右 ， 其实 ansible 和 libvirt …"/>
<meta property="og:locale" content="zh_CN"/>
<meta property="og:url" content="../../../2016/10/08/auto-install-debian-with-libvirt-and-preseed.html"/>
<meta property="og:type" content="article"/>
<meta property="article:published_time" content="2016-10-08 00:16:40+08:00"/>
<meta property="article:modified_time" content="2016-12-31 21:10:53+08:00"/>
<meta property="article:author" content="../../../author/hui-yiqun.html">
<meta property="article:section" content="Ops"/>
<meta property="og:image" content="https://secure.gravatar.com/avatar/e96680ba97e70a013f818edde6753ca8?s=120">

  <title>Notepad &ndash; 使用libvirt和preseed自动部署运行于KVM上的Debian虚拟机</title>

</head>
<body>
  <aside>
    <div>
      <a href="../../..">
        <img src="https://secure.gravatar.com/avatar/e96680ba97e70a013f818edde6753ca8?s=120" alt="Notepad" title="Notepad">
      </a>
      <h1><a href="../../..">Notepad</a></h1>

<p>The Power of Writing</p>
      <nav>
        <ul class="list">

          <li><a href="https://tuna.moe/" target="_blank">TUNA</a></li>
        </ul>
      </nav>

      <ul class="social">
        <li><a class="sc-github" href="https://github.com/huiyiqun" target="_blank"><i class="fa fa-github"></i></a></li>
        <li><a class="sc-stack-overflow" href="https://stackoverflow.com/users/2825773/given92" target="_blank"><i class="fa fa-stack-overflow"></i></a></li>
        <li><a class="sc-google-plus" href="https://plus.google.com/u/0/107187513671494024284" target="_blank"><i class="fa fa-google-plus"></i></a></li>
        <li><a class="sc-telegram" href="https://telegram.me/huiyiqun" target="_blank"><i class="fa fa-telegram"></i></a></li>
        <li><a class="sc-rss" href="https://blog.huiyiqun.me/feed.xml" target="_blank"><i class="fa fa-rss"></i></a></li>
      </ul>
    </div>


  </aside>
  <main>


<article class="single">
  <header>
    <h1 id="auto-install-debian-with-libvirt-and-preseed">使用libvirt和preseed自动部署运行于KVM上的Debian虚拟机</h1>
    <p>
          Posted on Sat 08 October 2016 in <a href="../../../category/ops.html">Ops</a>


    </p>
  </header>


  <div>
    <h1> 前言 </h1>
<p> 有一年多没有写东西了 ， 期间还是做了不少事情 ， 但是因为博 (zi) 客 (ji) 有 (te) 点 (bie) 丑 (lan)，
 什么都没有写 。 很多东西花了很多时间去学和折腾 ， 回头要用到的时候又需要重新去 
 翻文档 ， 实在是浪费时间 ， 于是决定把博客续上 。</p>
<p> 之所以会需要装虚拟机 ， 是因为 TUNA 最近又招了不少萌新 ， 萌新们可能需要一台 UNIX 的设备来瞎折腾 ，
 另外协会内部偶尔需要交换 slide 或者活动视频 ， 大鹰主席又觉得通过 “ 网盘 ” 交换文件实在太羞耻 ，
 因为我之前折腾过一下 KVM， 因而让我部署一台 Debian 的虚拟机 。</p>
<p> 本来是一件简单的重复劳动 ， 但是基于以下理由 ：</p>
<ol>
<li> 萌新可能把机器弄坏或者机器需要搬家 </li>
<li> 以后会长可能会让我装第二个机器 </li>
<li><s> 好久没折腾了感觉皮子有点紧 ~~</s></li>
</ol>
<p> 决定用 ansible 自动安装 。 整个过程花了大概两天左右 ， 其实 ansible 和 libvirt 都还算好 ， 文档挺齐全 
 的 ， 而且实现上 bug 不多 ， 但是 preseed 的文档少而且比较乱 ， 经常遇到文档和实际情况不符合的情况 。</p>
<h1> 环境 </h1>
<p> 宿主机是一个 Debian jessie， 上面跑了各种各样的其他服务 ， 包括且不限于 docker、nginx、
 私有的 ldap 服务等 。</p>
<p> 虚拟机依然是一个 Debian jessie， 上面需要部署一些基本的服务 ， 比如基于 ldap 的 pam 模块等 ， 方便 
 用户的登录 。</p>
<h1> 宿主机 </h1>
<p>qemu 本身的接口本身比较简陋 ， 我一般是用 libvirt 来管理 。</p>
<p> 因此通过 apt 安装上 <code>qemu-kvm</code> 和 <code>libvirt-bin</code>。
Debian 上安装好包之后默认服务就启动了 ， 因此不需要主动启动 <code>libvirtd</code>， 宿主机基本就配置好了 。</p>
<h1> 虚拟机 </h1>
<p> 此前安装系统都是通过 <code>virt-install</code> 或者封装得更严实的 <code>virt-manager</code>。
<code>virt-manager</code> 的安装过程基于 GUI， 重复安装很不方便 ；
<code>virt-install</code> 相对要方便很多 ， 不过感觉比较玄学 ， 完全不知道它背后做了什么 。</p>
<p>github 上能找到的自动安装项目基本都是基于 <code>virt-install</code> 的 ， 这次我想尝试直接基于 <code>libvirt</code> 的 
xml 文件配置来实现更灵活的安装过程控制 。</p>
<h2>Network</h2>
<p> 因为使用了 ansible， 网络的配置是给定了一个 xml 文件 ， 然后用 <code>virt-net</code> 模块把这个 xml 传进去 ，
 网络就定义好了 。</p>
<p> 因为会长想要一个 nat 网络 ， 对外只暴露一个 ssh 的端口 ， 因此网络配置上选择了 nat 网络 +DNAT 的方式 。</p>
<p> 以下是我使用的 xml。</p>
<div class="highlight"><pre><span></span><span class="nt">&lt;network&gt;</span>
  <span class="nt">&lt;name&gt;</span>nat<span class="nt">&lt;/name&gt;</span>
  <span class="nt">&lt;forward</span> <span class="na">mode=</span><span class="s">&quot;nat&quot;</span><span class="nt">/&gt;</span>
  <span class="nt">&lt;ip</span> <span class="na">address=</span><span class="s">&quot;192.168.101.1&quot;</span> <span class="na">netmask=</span><span class="s">&quot;255.255.255.0&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;dhcp&gt;</span>
      <span class="nt">&lt;range</span> <span class="na">start=</span><span class="s">&quot;192.168.101.2&quot;</span> <span class="na">end=</span><span class="s">&quot;192.168.101.254&quot;</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;host</span> <span class="na">mac=</span><span class="s">&quot;02:33:33:33:33:33&quot;</span> <span class="na">name=</span><span class="s">&quot;everest&quot;</span> <span class="na">ip=</span><span class="s">&quot;192.168.101.100&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/dhcp&gt;</span>
  <span class="nt">&lt;/ip&gt;</span>
<span class="nt">&lt;/network&gt;</span>
</pre></div>


<p> 需要说的是 dhcp 这个 tag 里的内容 ， 为了将虚拟机的 22 端口暴露到外网 ， 最简单地做法是固定虚拟机 
 的 ip 地址 。</p>
<p> 本来我计划在这个网段中不起 dhcp 服务 ， 直接通过 preseed（ 也就是 Debian 的自动部署工具 ） 来自动 
 配置一个静态地址 ， 这样看上去是比较合理的 。 但是 preseed 和 anaconda（CentOS 的自动部署工具 ）
 在工作流程上有一些本质的区别 ：</p>
<ul>
<li>
<p>anaconda 如果配置了用 kickstart（anaconda 的配置 ） 安装 ， 那么 anaconda 在运行之前会先尝试 
 去下载指定的 kickstart 文件 ， 如果下载失败会出错退出 。 所以如果要通过网络指定 kickstart 需要用 
 启动参数 （boot parameters）<code>ip</code> 来配置虚拟机的网络 ， 然后内核把控制权交给  anaconda 之后 ，
anaconda 才能获取 kickstart 文件进行安装 ， 接着根据 kickstart 的内容来进行安装 。</p>
</li>
<li>
<p>preseed 则完全不同 ， 如果配置了用 preseed 配置安装 ，preseed 会把下载 preseed 配置作为 
 其工作流程的一步插到网络配置的后面 ， 也就是说当 preseed 拿到配置文件的时候 ， 它已经用默认值 
（DHCP） 运行完了其所有网络配置 ，preseed 中的网络 、 域名等配置完全不会生效 。</p>
</li>
</ul>
<p> 虽然文档中也提到了可以用启动参数的方式指定其网络配置 ， 但是我试了一下 ， 没有生效 。 并且 
 这个时候我对于 preseed 已经基本失望了 。 所以我决定把复杂的配置放到 libvirt 里 ， 让 preseed
 里面的配置尽可能少 。</p>
<p> 所以这里我配了一个给 guest 分配 “ 静态地址 ” 的 dhcp 服务器 。</p>
<h2>Storage</h2>
<p> 虚拟机的硬盘相对比较简单 ， 直接用 qemu-img 就好了 。 因为了用了 ansible， 用了 
<a href="https://github.com/ansible-provisioning/ansible-provisioning/blob/master/library/qemu_img"> 这里 </a>
 一个现成的模块 ， 放到 role 的 library 目录下就能正常工作了 。</p>
<p>（ 我一般不喜欢造轮子 ， 算优点也算缺点吧 。）</p>
<p> 接下来把目录建成 <code>virt-pool</code> 方便使用 。</p>
<h2>Installing Domain</h2>
<p> 如果在物理机上安装一个新的操作系统 ， 你需要下载一个 ISO， 烧到 dvd 或者 U 盘里 ， 再调整 bios 里的 
 启动顺序 。</p>
<p> 如果需要自动化安装 ， 在进入安装界面之后 ， 可以找到一些快捷键 ， 可以进入一个 prompt 模式 ， 在 
 里面输入一些参数 （ 一般来说等于修改启动参数 ）， 接着就能一路安装下去 。</p>
<p> 在虚拟机里其实也很类似 ， 对于一个虚拟机 ， 虽然安装时和安装后共享一个硬盘 ， 但是启动顺序 、
 是否有 ISO、 有什么启动参数都完全不一样 。 也就是说安装中和安装后需要定义两个不完全相同的 
domain。</p>
<p> 以下是我在安装时用的 xml 文件 ：</p>
<div class="highlight"><pre><span></span><span class="nt">&lt;domain</span> <span class="na">type=</span><span class="s">&#39;kvm&#39;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;name&gt;</span>shared-guest<span class="nt">&lt;/name&gt;</span>
  <span class="nt">&lt;memory</span> <span class="na">unit=</span><span class="s">&#39;MB&#39;</span><span class="nt">&gt;</span>4096<span class="nt">&lt;/memory&gt;</span>
  <span class="nt">&lt;vcpu&gt;</span>2<span class="nt">&lt;/vcpu&gt;</span>
  <span class="nt">&lt;os&gt;</span>
    <span class="nt">&lt;type&gt;</span>hvm<span class="nt">&lt;/type&gt;</span>
    <span class="nt">&lt;boot</span> <span class="na">dev=</span><span class="s">&#39;cdrom&#39;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;kernel&gt;</span>/data/iso/vmlinuz<span class="nt">&lt;/kernel&gt;</span>
    <span class="nt">&lt;initrd&gt;</span>/data/iso/initrd.gz<span class="nt">&lt;/initrd&gt;</span>
    <span class="nt">&lt;cmdline&gt;</span>console=ttyS0 auto=true priority=critical url=&quot;http://192.168.101.1:2015/preseed-shared-guest.txt&quot; interface=auto netcfg/dhcp_timeout=60<span class="nt">&lt;/cmdline&gt;</span>
  <span class="nt">&lt;/os&gt;</span>
  <span class="nt">&lt;devices&gt;</span>
    <span class="nt">&lt;disk</span> <span class="na">type=</span><span class="s">&#39;volume&#39;</span> <span class="na">device=</span><span class="s">&#39;disk&#39;</span><span class="nt">&gt;</span>
      <span class="nt">&lt;source</span> <span class="na">pool=</span><span class="s">&#39;vms&#39;</span> <span class="na">volume=</span><span class="s">&#39;shared-guest.qcow2&#39;</span><span class="nt">/&gt;</span>
      <span class="nt">&lt;target</span> <span class="na">dev=</span><span class="s">&#39;hda&#39;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/disk&gt;</span>
    <span class="nt">&lt;disk</span> <span class="na">type=</span><span class="s">&#39;volume&#39;</span> <span class="na">device=</span><span class="s">&#39;cdrom&#39;</span><span class="nt">&gt;</span>
      <span class="nt">&lt;driver</span> <span class="na">name=</span><span class="s">&#39;qemu&#39;</span> <span class="na">type=</span><span class="s">&#39;raw&#39;</span><span class="nt">/&gt;</span>
      <span class="nt">&lt;source</span> <span class="na">pool=</span><span class="s">&#39;iso&#39;</span> <span class="na">volume=</span><span class="s">&#39;debian-8.6.0-amd64-netinst.iso&#39;</span><span class="nt">/&gt;</span>
      <span class="nt">&lt;target</span> <span class="na">dev=</span><span class="s">&#39;hdc&#39;</span> <span class="na">bus=</span><span class="s">&#39;ide&#39;</span><span class="nt">/&gt;</span>
      <span class="nt">&lt;readonly/&gt;</span>
    <span class="nt">&lt;/disk&gt;</span>
    <span class="nt">&lt;interface</span> <span class="na">type=</span><span class="s">&#39;network&#39;</span><span class="nt">&gt;</span>
      <span class="nt">&lt;source</span> <span class="na">network=</span><span class="s">&#39;nat&#39;</span><span class="nt">/&gt;</span>
      <span class="nt">&lt;mac</span> <span class="na">address=</span><span class="s">&#39;02:33:33:33:33:33&#39;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/interface&gt;</span>
    <span class="nt">&lt;serial</span> <span class="na">type=</span><span class="s">&#39;pty&#39;</span><span class="nt">&gt;</span>
      <span class="nt">&lt;target</span> <span class="na">port=</span><span class="s">&#39;0&#39;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/serial&gt;</span>
    <span class="nt">&lt;console</span> <span class="na">type=</span><span class="s">&#39;pty&#39;</span><span class="nt">&gt;</span>
      <span class="nt">&lt;target</span> <span class="na">type=</span><span class="s">&#39;serial&#39;</span> <span class="na">port=</span><span class="s">&#39;0&#39;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/console&gt;</span>
  <span class="nt">&lt;/devices&gt;</span>
<span class="nt">&lt;/domain&gt;</span>
</pre></div>


<p>os 这个 tag 里的内容定义了 domain 的启动选项 。 这里 boot 这个 tag 应该没有生效 ， 是遗留代码 ， 主要是通过 
kernel、initrd、cmdline 三个参数实现了 <a href="https://libvirt.org/formatdomain.html#elementsOSKernel">Direct kernel boot</a>。
 以此达到指定启动参数的目的 。</p>
<p>kernel 和 initrd 里的文件理论上应该从 iso 里面解出来 ， 在这里 ， 我偷了个懒 ， 直接从 
<a href="https://mirrors.tuna.tsinghua.edu.cn/debian/dists/jessie/main/installer-amd64/current/images/cdrom/"> 这里 </a>
 下载的 。</p>
<p><code>device</code> 这个 tag 里前两个 <code>disk</code> 分别是之前建的虚拟硬盘和下载的安装 iso。</p>
<p><code>interface</code> 则挂载到了之前建的 nat 网络上 ， 注意到 mac 地址需要与之前的 mac 地址对应 。</p>
<p> 最后的 <code>serial</code> 与 <code>console</code> 和 <code>cmdline</code> 里的 console=ttyS0 配合 ， 这样可以通过 <code>virsh console</code>
 命令将标准 IO 和安装过程接起来 ， 可以交互式的安装 ， 也可以看安装进度 。</p>
<p> 关于 cmdline 里的其他参数 ，<code>auto=true priority=critical</code> 保证了 preseed 自动安装并且不会被一 
 些低优先级的问题打断 ， 比如询问 hostname 之类的 ， 但是并不能跳过所有问题 ， 比如如果 preseed
 里面没有设置 root 密码也没有选择跳过建 root 用户 ， 安装过程就会停下来等用户输入 root 密码 。</p>
<p><code>url</code> 指定了配置文件的 url，preseed 配置完网络之后会从这个地方下载配置文件 。 貌似也支持其他 
 协议 ， 不过没有试过 。</p>
<p> 剩下两个参数应该是没什么用处的 ， 算是遗留代码 。</p>
<p> 更多的详细信息可以看 <a href="https://www.debian.org/releases/jessie/amd64/apbs02.html.en"> 这里 </a>。</p>
<p> 当你确定安装不需要任何人工干预之后 ， 可以把 serial 这个 tag 改成如下内容 ：</p>
<div class="highlight"><pre><span></span><span class="nt">&lt;serial</span> <span class="na">type=</span><span class="s">&#39;file&#39;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;source</span> <span class="na">path=</span><span class="s">&quot;/tmp/shared-guest-serial0.log&quot;</span><span class="nt">/&gt;</span>
  <span class="nt">&lt;target</span> <span class="na">port=</span><span class="s">&#39;0&#39;</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/serial&gt;</span>
</pre></div>


<p> 这样 libvirt 会把虚拟机的 ttyS0 的输出接到物理机的 <code>/tmp/shared-guest-serial0.log</code> 这个文件 。
 然后通过 </p>
<div class="highlight"><pre><span></span>~&gt; sudo tail -f /tmp/shared-guest-serial0.log
</pre></div>


<p> 这个命令就可以查看安装进度了 ， 但是不能进行交互了 。</p>
<p> 这样有如下两个好处 ：</p>
<ol>
<li>console 是独占的 ， 而文件本身是共享的 ， 多个人可以同时浏览安装进度 。</li>
<li> 方便使用 ansible 的 <code>wait_for</code> 这个模块来监视安装的进度 。</li>
</ol>
<h2>Preseed</h2>
<p> 上面的启动参数里写到了 ， 需要从物理机的 http 服务器上获取 preseed。 我用 <code>daemon</code> 和 <code>caddy</code> 配合在 
 宿主机上起了一个简单的 http 服务器 ， 主要是考虑如何在 ansible 里起简单的 daemon。
 灵感来源于 <a href="http://stackoverflow.com/a/29822700">stackoverflow</a>， 具体的细节就不赘述了 ，
 感兴趣可以直接去看 github 看这个 repo 的内容 。</p>
<p> 关于 Preseed， 我使用了 <a href="https://www.debian.org/releases/jessie/example-preseed.txt"> 这里 </a>
 的模板 。</p>
<p> 有几个地方需要注意 ：</p>
<ol>
<li> 网络配置是不会起作用的 ， 不要白费力气了 。</li>
<li><s> 不要设置 <code>apt-setup/security_host</code>！ 如果你设置 <code>apt-setup/security_host</code> 为 <code>mirror.example.com</code>， 那么 apt 会尝试访问 <code>http://mirror.example.com/</code> 而不是 <code>http://mirror.example.com/debian-security</code>，google 了一下发现有一个 <code>apt-setup/security_path</code> 这个参数解决这个问题 ， 但是首先 example 里没有 ， 其次我加上也没有效果 ， 应该是这个版本的 bug。</s> 根据 @zhsj 提供的信息 ， 可以把 <code>security_path</code> 放到 <code>security_host</code> 后面 workaround 这个问题 ， 也就是 <code>apt-setup/security_host=https://mirrors.tuna.tsinghua.edu.cn/debian-security</code>。</li>
<li> 同理也不要设置 <code>apt-setup/non-free</code> 和 <code>apt-setup/contrib</code>， 类似的问题 。 不过 mirror settings 没问题 。</li>
<li><code>tasksel/first</code> 这里一定要配置 ， 并且只留下 standard， 否则会给你把 gnome 一起装上 。</li>
<li><code>debian-installer/exit/poweroff</code> 是没什么用的 ， 最后系统还是会 halt 住 ，<code>virsh status</code> 里显示的依然是 running。</li>
</ol>
<p>preseed 太长 ， 也不放在这里了 ， 感兴趣可以去 repo 看 。</p>
<p> 关于不能关机的问题 ， 我用 ansible 的 <code>wait_for</code> 监视了 serial 输出的日志文件 ， 如果看到了最后几个字符就 destroy。</p>
<h2>Installed Domain</h2>
<p> 接着整个虚拟机就安装好了 ， 直接 undefine 原来的 domain， 然后重新定义一个 domain 就好 ， 因为 disk
 不变 ， 所以安装好的系统依然还在 。</p>
<p> 就像我们安装物理机时重启时会调整启动顺序 ， 启动参数等等 ， 这里我们需要重新定义 domain。</p>
<p> 新定义的 xml 如下 ：</p>
<div class="highlight"><pre><span></span><span class="nt">&lt;domain</span> <span class="na">type=</span><span class="s">&#39;kvm&#39;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;name&gt;</span>shared-guest<span class="nt">&lt;/name&gt;</span>
  <span class="nt">&lt;memory</span> <span class="na">unit=</span><span class="s">&#39;MB&#39;</span><span class="nt">&gt;</span>4096<span class="nt">&lt;/memory&gt;</span>
  <span class="nt">&lt;vcpu&gt;</span>2<span class="nt">&lt;/vcpu&gt;</span>
  <span class="nt">&lt;os&gt;</span>
    <span class="nt">&lt;type&gt;</span>hvm<span class="nt">&lt;/type&gt;</span>
    <span class="nt">&lt;boot</span> <span class="na">dev=</span><span class="s">&#39;hd&#39;</span><span class="nt">/&gt;</span>
  <span class="nt">&lt;/os&gt;</span>
  <span class="nt">&lt;devices&gt;</span>
    <span class="nt">&lt;disk</span> <span class="na">type=</span><span class="s">&#39;volume&#39;</span> <span class="na">device=</span><span class="s">&#39;disk&#39;</span><span class="nt">&gt;</span>
      <span class="nt">&lt;source</span> <span class="na">pool=</span><span class="s">&#39;vms&#39;</span> <span class="na">volume=</span><span class="s">&#39;shared-guest.qcow2&#39;</span><span class="nt">/&gt;</span>
      <span class="nt">&lt;target</span> <span class="na">dev=</span><span class="s">&#39;hda&#39;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/disk&gt;</span>
    <span class="nt">&lt;interface</span> <span class="na">type=</span><span class="s">&#39;network&#39;</span><span class="nt">&gt;</span>
      <span class="nt">&lt;source</span> <span class="na">network=</span><span class="s">&#39;nat&#39;</span><span class="nt">/&gt;</span>
      <span class="nt">&lt;mac</span> <span class="na">address=</span><span class="s">&#39;02:33:33:33:33:33&#39;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/interface&gt;</span>
    <span class="nt">&lt;serial</span> <span class="na">type=</span><span class="s">&#39;pty&#39;</span><span class="nt">&gt;</span>
      <span class="nt">&lt;target</span> <span class="na">port=</span><span class="s">&#39;0&#39;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/serial&gt;</span>
    <span class="nt">&lt;console</span> <span class="na">type=</span><span class="s">&#39;pty&#39;</span><span class="nt">&gt;</span>
      <span class="nt">&lt;target</span> <span class="na">type=</span><span class="s">&#39;serial&#39;</span> <span class="na">port=</span><span class="s">&#39;0&#39;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/console&gt;</span>
  <span class="nt">&lt;/devices&gt;</span>
<span class="nt">&lt;/domain&gt;</span>
</pre></div>


<p> 可以看到非常简单 ， 启动列表里面只剩了 hd，iso 也被去掉了 ，serial 的配置还原回了交互式的 ，
 这样未来网络出问题不能 ssh 登录时可以通过 virsh 的 console 登录去调试 。</p>
<h2>DNAT</h2>
<p> 为了从互联网可以直接 ssh 访问虚拟机 ， 需要配一下 iptables， 直接看 ansible 脚本吧 ：</p>
<div class="highlight"><pre><span></span><span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">set up DNAT for ssh</span>
  <span class="l l-Scalar l-Scalar-Plain">iptables</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">table</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">nat</span>
    <span class="l l-Scalar l-Scalar-Plain">chain</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">PREROUTING</span>
    <span class="l l-Scalar l-Scalar-Plain">in_interface</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">eth0</span>
    <span class="l l-Scalar l-Scalar-Plain">protocol</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">tcp</span>
    <span class="l l-Scalar l-Scalar-Plain">match</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">tcp</span>
    <span class="l l-Scalar l-Scalar-Plain">destination_port</span><span class="p p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">hostvars[&#39;kvm-guest&#39;][&#39;ansible_port&#39;]</span><span class="nv"> </span><span class="s">}}&quot;</span>
    <span class="l l-Scalar l-Scalar-Plain">jump</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">DNAT</span>
    <span class="l l-Scalar l-Scalar-Plain">to_destination</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">192.168.101.100:22</span>
    <span class="l l-Scalar l-Scalar-Plain">comment</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">DNAT rule for ssh service of everest</span>

<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">enable forwarding for ssh</span>
  <span class="l l-Scalar l-Scalar-Plain">iptables</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">action</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">insert</span>
    <span class="l l-Scalar l-Scalar-Plain">chain</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">FORWARD</span>
    <span class="l l-Scalar l-Scalar-Plain">in_interface</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">eth0</span>
    <span class="l l-Scalar l-Scalar-Plain">destination</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">192.168.101.100</span>
    <span class="l l-Scalar l-Scalar-Plain">destination_port</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">22</span>
    <span class="l l-Scalar l-Scalar-Plain">protocol</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">tcp</span>
    <span class="l l-Scalar l-Scalar-Plain">jump</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">ACCEPT</span>
    <span class="l l-Scalar l-Scalar-Plain">comment</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">allow ssh connection for everest to be forwarded</span>
</pre></div>


<p>Debian 是默认不会 drop forward 的包的 ， 但是 libvirt 为 NAT 网络在 iptables 里配了两条 drop 规则 ，
 所以需要在这两条规则之前加一个 accept 规则 ， 这也是必须要 <code>action: insert</code> 的原因 ， 不幸的是 
 这是 ansible 2.2 新加的特性 ， 写文的时候还没有正式发布 ， 所以安装比较麻烦 。
repo 的 README 里有一个临时的 workaround。</p>
<h2>Post installation</h2>
<p> 写 ansible 的时候用了一点小技巧 ， 安装好的虚拟机的 username 和 password 就是 inventory 里 
 的 <code>ansible_user</code> 和 <code>ansible_ssh_pass</code>， 这样在虚拟机安装完之后通过 ansible 可以直接 
 地访问虚拟机 ， 因此简单地写一些 ansible 脚本 ， 可以完成一些配置 。</p>
<p> 关于非网络的配置 ， 在这里做比在 preseed 里做会更加可靠 。</p>
<h1>NOTE</h1>
<ol>
<li> 上面提到的 preseed 的坑只适用于 Debian jessie， 可能不适用于其他版本 ， 更不适用于 Ubuntu。</li>
<li> 完整项目的 <a href="https://github.com/tuna/playbooks/tree/master/shared-guest"> 链接 </a>。</li>
</ol>
  </div>
  <div class="tag-cloud">
    <p>
    </p>
  </div>




<div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = 'huiyiqun';
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>
        Please enable JavaScript to view comments.

</noscript>
</article>

    <footer>
<p>&copy; Hui Yiqun 2016</p>
<p>    Powered by <a href="http://getpelican.com" target="_blank">Pelican</a> - <a href="https://github.com/alexandrevicenzi/flex" target="_blank">Flex</a> theme by <a href="http://alexandrevicenzi.com" target="_blank">Alexandre Vicenzi</a>
</p>    </footer>
  </main>

<!-- Google Analytics -->
<script type="text/javascript">
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-89649249-1', 'auto');
  ga('send', 'pageview');
</script>
<!-- End Google Analytics -->



<script type="application/ld+json">
{
  "@context" : "http://schema.org",
  "@type" : "Blog",
  "name": " Notepad ",
  "url" : "../../..",
  "image": "https://secure.gravatar.com/avatar/e96680ba97e70a013f818edde6753ca8?s=120",
  "description": ""
}
</script>
</body>
</html>