<!DOCTYPE html>
<html lang="zh">
<head>
        <meta charset="utf-8" />
        <title>archlinux上用systemd-networkd与hostapd配置无线ap</title>
        <link rel="stylesheet" href="https://blog.huiyiqun.me/theme/css/main.css" />
        <link href="https://blog.huiyiqun.me/feed.xml" type="application/atom+xml" rel="alternate" title="Notepad Atom Feed" />

        <!--[if IE]>
            <script src="https://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="https://blog.huiyiqun.me/">Notepad </a></h1>
                <nav><ul>
                    <li><a href="https://blog.huiyiqun.me/category/android.html">Android</a></li>
                    <li><a href="https://blog.huiyiqun.me/category/multimedia.html">Multimedia</a></li>
                    <li class="active"><a href="https://blog.huiyiqun.me/category/ops.html">Ops</a></li>
                    <li><a href="https://blog.huiyiqun.me/category/python.html">Python</a></li>
                </ul></nav>
        </header><!-- /#banner -->
<section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="https://blog.huiyiqun.me/2016/10/08/syst-networkd-and-hostapd.md.html" rel="bookmark"
           title="Permalink to archlinux上用systemd-networkd与hostapd配置无线ap">archlinux上用systemd-networkd与hostapd配置无线ap</a></h1>
    </header>

    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2016-10-08T17:21:11+08:00">
                Published: Sat 08 October 2016
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="https://blog.huiyiqun.me/author/hui-yiqun.html">Hui Yiqun</a>
        </address>
<p>In <a href="https://blog.huiyiqun.me/category/ops.html">Ops</a>.</p>

</footer><!-- /.post-info -->      <h1>环境</h1>
<p>这套配置我现在运行在了两个地方，一个是我家里的minipc上，当软路由用，另一个则是我实验室的
PC，因为实验室的公共Wifi效果实在不能让人满意，决定自己在PC上插两个USB无线网卡当无线路由器用。</p>
<p>环境上用的都是Archlinux。</p>
<p>这是minipc上的无线网卡：</p>
<div class="highlight"><pre><span></span>~&gt; lsusb
Bus 002 Device 002: ID 148f:5572 Ralink Technology, Corp. RT5572 Wireless Adapter

~&gt; lspci
01:00.0 Ethernet controller: Realtek Semiconductor Co., Ltd. RTL8111/8168/8411 PCI Express Gigabit Ethernet Controller(rev 06)
</pre></div>


<p>这是实验室PC上的无线网卡：</p>
<div class="highlight"><pre><span></span>~&gt; lsusb
Bus 003 Device 002: ID 0bda:8178 Realtek Semiconductor Corp. RTL8192CU 802.11n WLAN Adapter
Bus 003 Device 003: ID 148f:5572 Ralink Technology, Corp. RT5572 Wireless Adapter
</pre></div>


<p>比较推荐Ralink的这个<a href="https://gist.github.com/huiyiqun/9c9b00631768bc5b31971235462eba62">网卡</a>，京东上49块，
驱动在主线内核里，支持2.4Ghz/5Ghz，稳定性也不错。</p>
<p>软件版本上：</p>
<div class="highlight"><pre><span></span>~&gt; systemctl --version
systemd 231
+PAM -AUDIT -SELINUX -IMA -APPARMOR +SMACK -SYSVINIT +UTMP +LIBCRYPTSETUP +GCRYPT +GNUTLS +ACL +XZ +LZ4 +SECCOMP +BLKID +ELFUTILS +KMOD +IDN

~&gt; hostapd -v
hostapd v2.6
User space daemon for IEEE 802.11 AP management,
IEEE 802.1X/WPA/WPA2/EAP/RADIUS Authenticator
Copyright (c) 2002-2016, Jouni Malinen &lt;j@w1.fi&gt; and contributors
</pre></div>


<h1>Hostapd</h1>
<p>如果提到hostapd，大概会有人觉得<code>create_ap</code>会更好用一些。我承认，你抱着笔记本回家过年，年夜饭
桌上有人需要临时用一下ap，<code>create_ap</code>确实是一个十分有效的工具，但是如果是自己实验室或寝室的
长期使用的ap，<code>create_ap</code>显得有点笨重，它把dns、dhcp以及路由的配置都糅合进去了。对于复杂的网络
配置，我认为并不比hostapd简单。</p>
<p>hostapd的配置其实比较简单，顺着默认的配置文件读一遍就基本知道该怎么配了，我也没有配多个ssid的需求，
配置起来就更简单了。</p>
<p>折腾的地方主要在systemd配置。hostapd自己提供了一个service文件，但是它有两个问题：</p>
<ol>
<li>不支持同时运行多个hostapd实例</li>
<li>Unit写着After network.target，这样导致了hostapd启动的时候网络配置已经结束了，这里有一个坑，后面再说。
实际上hostapd不同于其他网络服务，它并不需要网络访问，也不需要听socket，只需要网卡初始化即可。</li>
</ol>
<p>因此修改之后的service应该是：</p>
<div class="highlight"><pre><span></span><span class="k">[Unit]</span>
<span class="na">Description</span><span class="o">=</span><span class="s">Hostapd IEEE 802.11 AP, IEEE 802.1X/WPA/WPA2/EAP/RADIUS Authenticator</span>
<span class="na">After</span><span class="o">=</span><span class="s">sys-subsystem-net-devices-%i.device</span>
<span class="na">BindsTo</span><span class="o">=</span><span class="s">sys-subsystem-net-devices-%i.device</span>
<span class="na">Before</span><span class="o">=</span><span class="s">network.target systemd-networkd.service</span>

<span class="k">[Service]</span>
<span class="na">ExecStart</span><span class="o">=</span><span class="s">/usr/bin/hostapd /etc/hostapd/%i.conf</span>
<span class="na">ExecReload</span><span class="o">=</span><span class="s">/bin/kill -HUP $MAINPID</span>

<span class="k">[Install]</span>
<span class="na">WantedBy</span><span class="o">=</span><span class="s">multi-user.target</span>
</pre></div>


<p>%i会替换成对应的interface名，<code>After=network.target</code>改成了<code>Before=network.target systemd-networkd.service</code>，
这样systemd-networkd会等hostapd启动之后才会运行。</p>
<p><code>After=</code>保证了hostapd运行时网卡已经启动了。<code>BindsTo=</code>则保证网卡被拔掉之后hostapd自动关闭。</p>
<p>之后把interface对应的配置文件写到<code>/etc/hostapd/&lt;interface&gt;.conf</code>。</p>
<p>禁用系统自带的service：</p>
<div class="highlight"><pre><span></span>~&gt; sudo systemctl mask hostapd
</pre></div>


<p>启用新的service：</p>
<div class="highlight"><pre><span></span>~&gt; sudo systemctl enable hostapd@&lt;interface&gt; --now
</pre></div>


<p>如果service运行不出错，interface就已经正常起来了，这个时候你的手机已经能搜到这个ap了，但是现在是连不上的，
因为网卡没有配置ip，也没有配置dhcp。</p>
<p>这些工作都交给systemd-networkd了。</p>
<h1>关于systemd-networkd</h1>
<p>systemd-networkd用了有一段时间了，不太适合经常变化的网络，但是对于网络状况比较固定
但是网络环境比较复杂的机器还是挺适合的，比如soft ap。</p>
<p>systemd-networkd一个比较舒服的地方是，你可以简单的把所有的网络配置都写在一个统一的地方，
而不用写在各种各样的<code>up.sh</code>里，这样也免得弄乱。</p>
<p>我曾经遇到过一个问题，我的一台跳板机器上配了一个openvpn，在openvpn的<code>up.sh</code>里配置了一套
玄学路由，后来家昌喵配了另一个VPN，需要这套玄学路由，居然把他的VPN的up脚本直接写到了我的
<code>up.sh</code>里，最后网络变得一团糟。</p>
<p>后来跳板机迁移，我在up.sh里就写了<code>ip link xxx up</code>。其他的配置都扔到了systemd.network里，这样
思路就清晰多了，玄学路由也被拆了出来。</p>
<p>对于systemd-networkd来说，它不在乎你的interface来自于vpn，有线网卡还是无线网卡，只要interface
up了，它就将配置写进去。这样能让我专注于网络拓扑本身，而不是它的接入方式。</p>
<p>如果仅仅只有一个无线网卡需要配置，那么直接写一个<code>systemd.network</code>配置就可以了。但是我的两个pc
都有两个网卡，而且我希望这个两个网卡的ap接入的是同一个子网（大多数市面上的无线路由器都是这样的），
因此需要用网桥把两个interface接到一起。</p>
<p>systemd-networkd在最近的版本里已经支持了网桥，只需要在<code>/etc/systemd/network/</code>下放一个netdev文件，
如<code>br0.netdev</code>：</p>
<div class="highlight"><pre><span></span><span class="k">[NetDev]</span>
<span class="na">Name</span><span class="o">=</span><span class="s">br0</span>
<span class="na">Kind</span><span class="o">=</span><span class="s">bridge</span>
</pre></div>


<p>接着用一个network文件(如ap.network)来配置interface加入到这个网桥里。</p>
<div class="highlight"><pre><span></span><span class="k">[Match]</span>
<span class="na">Name</span><span class="o">=</span><span class="s">xxxx</span>
<span class="na">Name</span><span class="o">=</span><span class="s">yyyy</span>

<span class="k">[Network]</span>
<span class="na">Bridge</span><span class="o">=</span><span class="s">br0</span>
</pre></div>


<p>Name 是你希望加入到这个网络中的网卡的interface名，也可以通过mac地址等其他方式来配置。</p>
<p>在自动启动的过程中，有可能会出现一个问题，就是systemd-networkd启动并且配置网桥并且将interface加入到
网桥的时候hostapd还没起来，这个时候的网卡不能加入到bridge里，github上有一个
<a href="https://github.com/systemd/systemd/issues/936">issue</a>。Before <code>systemd-networkd.service</code>解决了这个问题，
但是我感觉可能导致系统的启动时间变长，因为调度顺序上，hostapd被提前了，After <code>network.service</code>的服务需要
阻塞等待hostapd，anyway，我并没有实际感受到任何区别。</p>
<p>这样restart systemd-networkd之后就发现网卡已经加入到新建的bridge里了。这个时候直接配置这个bridge就可以了。
依然通过一个network文件(如br0.network)来配置。</p>
<div class="highlight"><pre><span></span><span class="k">[Match]</span>
<span class="na">Name</span><span class="o">=</span><span class="s">br0</span>

<span class="k">[Network]</span>
<span class="na">Address</span><span class="o">=</span><span class="s">192.168.233.1/24</span>
<span class="na">DHCPServer</span><span class="o">=</span><span class="s">yes</span>
<span class="na">IPForward</span><span class="o">=</span><span class="s">yes</span>
<span class="na">IPMasquerade</span><span class="o">=</span><span class="s">yes</span>

<span class="k">[DHCPServer]</span>
<span class="na">PoolOffset</span><span class="o">=</span><span class="s">100</span>
<span class="na">PoolSize</span><span class="o">=</span><span class="s">100</span>
<span class="na">DNS</span><span class="o">=</span><span class="s">192.168.233.1</span>
<span class="na">EmitRouter</span><span class="o">=</span><span class="s">yes</span>
<span class="na">EmitTimezone</span><span class="o">=</span><span class="s">yes</span>
</pre></div>


<p>配置已经很好懂，我给dhcp的地址池留了100个地址，方便未来可能会要配静态地址，100个地址对于我的usb网卡也差不多到
极限了。</p>
<p>DNS将连接设备的DNS解析器指向给定地址。</p>
<p>EmitRouter让连接上这个wifi的设备把默认路由设置成ap，也就是192.168.233.1，EmitTimeZone则会向设备广播时区。</p>
<p>有趣的是IPForward和IPMasquerade这两个选项，他们会分别替你打开sysctl里的forwarding以及在iptables里加入SNAT规则。
其中IPMasquerade隐含了IPForward，为了verbose，我还是都写上了。一方面比较省事，最重要的是，这个比脚本可读很多。</p>
<p>这样，网络部分的配置就完成了。</p>
<h1>DNS</h1>
<p>上面可以看到，我在PC上配置了一个DNS服务器，用的是dnsmasq，配置比较简单，也没出什么奇怪的问题。如果需要科学上网，
可以配合<a href="https://github.com/felixonmars/dnsmasq-china-list">dnsmasq-china-list</a>以及VPN使用。</p>
<p>VPN怎么配就不讲了。顺带一提，VPN的网络配置也是放在systemd-networkd里的。</p>
    </div><!-- /.entry-content -->
    <div class="comments">
      <h2>Comments !</h2>
      <div id="disqus_thread"></div>
      <script type="text/javascript">
        var disqus_shortname = 'huiyiqun';
        var disqus_identifier = '2016/10/08/syst-networkd-and-hostapd.md.html';
        var disqus_url = 'https://blog.huiyiqun.me/2016/10/08/syst-networkd-and-hostapd.md.html';
        (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//huiyiqun.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
      </script>
      <noscript>Please enable JavaScript to view the comments.</noscript>
    </div>

  </article>
</section>
        <section id="extras" class="body">
                <div class="blogroll">
                        <h2>links</h2>
                        <ul>
                            <li><a href="https://tuna.moe/">TUNA</a></li>
                        </ul>
                </div><!-- /.blogroll -->
                <div class="social">
                        <h2>social</h2>
                        <ul>
                            <li><a href="https://blog.huiyiqun.me/feed.xml" type="application/atom+xml" rel="alternate">atom feed</a></li>

                            <li><a href="https://github.com/huiyiqun">Github</a></li>
                            <li><a href="https://stackoverflow.com/users/2825773/given92">Stack Overflow</a></li>
                            <li><a href="https://plus.google.com/u/0/107187513671494024284">Google+</a></li>
                            <li><a href="https://telegram.me/huiyiqun">Telegram</a></li>
                        </ul>
                </div><!-- /.social -->
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->

                <p>The theme is by <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

    <script type="text/javascript">
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-89649249-1', 'auto');
    ga('send', 'pageview');
    </script>
<script type="text/javascript">
    var disqus_shortname = 'huiyiqun';
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = 'https://' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
</body>
</html>