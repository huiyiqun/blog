
<!DOCTYPE html>
<html lang="zh">
<head>
  <link href='//fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,700,400italic' rel='stylesheet' type='text/css'>

    <link rel="stylesheet" type="text/css" href="../../../theme/stylesheet/style.min.css">

  <link rel="stylesheet" type="text/css" href="../../../theme/pygments/default.min.css">
  <link rel="stylesheet" type="text/css" href="../../../theme/font-awesome/css/font-awesome.min.css">


    <link href="https://blog.huiyiqun.me/feed.xml" type="application/atom+xml" rel="alternate" title="Notepad Atom">



  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="HandheldFriendly" content="True" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="robots" content="" />

    <!-- Chrome, Firefox OS and Opera -->
    <meta name="theme-color" content="white">
    <!-- Windows Phone -->
    <meta name="msapplication-navbutton-color" content="white">
    <!-- iOS Safari -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

<meta name="author" content="Hui Yiqun" />
<meta name="description" content="关于 不得不说，这其实是一个非常悲惨的故事，作为自己25岁生日的礼物，稍微惨了一点。 最近一时兴起，用Vue.js写了一个很简单的前端项目，也算是希望能在离校之前给自己的学校留下一点东西。 起因 之前一切都很顺利，加feature，修bug，都没什么太大的困难，直到开始着手解决认证问题。 受限于各方面的限制，我写的前端所服务的后台服务是不能直接在校外访问的，然而不管是在校生还是已毕业校友都有在校外访问的需要，因此折中一下，这个服务需要认证才能访问。 认证是怎么做的呢？是一个比较传统的方案：先重定向到一个集中认证服务，登录完之后返回后台服务所在的域名，通过后台服务与认证服务交互，确认用户的登录情况，记录用户的身份，设置session，之后用cookie来识别用户的登录情况。 这部分其实与我的前端App没什么关系，因为不管是认证服务还是后台服务都是已经写好在运行的，我只要在访问后台服务的时候捕捉错误信息，正常跳转到认证服务，等待后台服务把用户重定向回来就行，因此与我来说看上去并没有什么关系。 然而问题在于，运行环境的服务器不由我管理，我也不愿意在运行环境下调试，因此我在自己的VPS和域名下部署了一套staging环境用于线上测试，自己开发则在本机用localhost开发，拜托运行的老师在nginx里加了CORS的HTTP headers，一切挺顺利，看上去也很合理，然而在折腾cookie的时候却出了问题。 兴起 虽然没有什么必须要用 …" />
<meta name="keywords" content="">
<meta property="og:site_name" content="Notepad"/>
<meta property="og:title" content="带cookie的CORS"/>
<meta property="og:description" content="关于 不得不说，这其实是一个非常悲惨的故事，作为自己25岁生日的礼物，稍微惨了一点。 最近一时兴起，用Vue.js写了一个很简单的前端项目，也算是希望能在离校之前给自己的学校留下一点东西。 起因 之前一切都很顺利，加feature，修bug，都没什么太大的困难，直到开始着手解决认证问题。 受限于各方面的限制，我写的前端所服务的后台服务是不能直接在校外访问的，然而不管是在校生还是已毕业校友都有在校外访问的需要，因此折中一下，这个服务需要认证才能访问。 认证是怎么做的呢？是一个比较传统的方案：先重定向到一个集中认证服务，登录完之后返回后台服务所在的域名，通过后台服务与认证服务交互，确认用户的登录情况，记录用户的身份，设置session，之后用cookie来识别用户的登录情况。 这部分其实与我的前端App没什么关系，因为不管是认证服务还是后台服务都是已经写好在运行的，我只要在访问后台服务的时候捕捉错误信息，正常跳转到认证服务，等待后台服务把用户重定向回来就行，因此与我来说看上去并没有什么关系。 然而问题在于，运行环境的服务器不由我管理，我也不愿意在运行环境下调试，因此我在自己的VPS和域名下部署了一套staging环境用于线上测试，自己开发则在本机用localhost开发，拜托运行的老师在nginx里加了CORS的HTTP headers，一切挺顺利，看上去也很合理，然而在折腾cookie的时候却出了问题。 兴起 虽然没有什么必须要用 …"/>
<meta property="og:locale" content="zh_CN"/>
<meta property="og:url" content="../../../2017/03/12/cors-request-with-cookie.html"/>
<meta property="og:type" content="article"/>
<meta property="article:published_time" content="2017-03-12 01:01:10+08:00"/>
<meta property="article:modified_time" content=""/>
<meta property="article:author" content="../../../author/hui-yiqun.html">
<meta property="article:section" content="Frontend"/>
<meta property="og:image" content="https://secure.gravatar.com/avatar/e96680ba97e70a013f818edde6753ca8?s=120">

  <title>Notepad &ndash; 带cookie的CORS</title>

</head>
<body>
<!-- Google Tag Manager -->
<noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-NW57T8B"
height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-NW57T8B');</script>
<!-- End Google Tag Manager -->  <aside>
    <div>
      <a href="../../..">
        <img src="https://secure.gravatar.com/avatar/e96680ba97e70a013f818edde6753ca8?s=120" alt="Notepad" title="Notepad">
      </a>
      <h1><a href="../../..">Notepad</a></h1>

<p>The Power of Writing</p>
      <nav>
        <ul class="list">

          <li><a href="https://tuna.moe/" target="_blank">TUNA</a></li>
        </ul>
      </nav>

      <ul class="social">
        <li><a class="sc-github" href="https://github.com/huiyiqun" target="_blank"><i class="fa fa-github"></i></a></li>
        <li><a class="sc-stack-overflow" href="https://stackoverflow.com/users/2825773/given92" target="_blank"><i class="fa fa-stack-overflow"></i></a></li>
        <li><a class="sc-google-plus" href="https://plus.google.com/u/0/107187513671494024284" target="_blank"><i class="fa fa-google-plus"></i></a></li>
        <li><a class="sc-telegram" href="https://telegram.me/huiyiqun" target="_blank"><i class="fa fa-telegram"></i></a></li>
        <li><a class="sc-rss" href="https://blog.huiyiqun.me/feed.xml" target="_blank"><i class="fa fa-rss"></i></a></li>
      </ul>
    </div>


  </aside>
  <main>


<article class="single">
  <header>
    <h1 id="cors-request-with-cookie">带cookie的CORS</h1>
    <p>
          Posted on Sun 12 March 2017 in <a href="../../../category/frontend.html">Frontend</a>


    </p>
  </header>


  <div>
    <h1>关于</h1>
<p>不得不说，这其实是一个非常悲惨的故事，作为自己25岁生日的礼物，稍微惨了一点。</p>
<p>最近一时兴起，用Vue.js写了一个很简单的<a href="https://github.com/huiyiqun/iptv">前端项目</a>，也算是希望能在离校之前给自己的学校留下一点东西。</p>
<h1>起因</h1>
<p>之前一切都很顺利，加feature，修bug，都没什么太大的困难，直到开始着手解决认证问题。</p>
<p>受限于各方面的限制，我写的前端所服务的后台服务是不能直接在校外访问的，然而不管是在校生还是已毕业校友都有在校外访问的需要，因此折中一下，这个服务需要认证才能访问。
认证是怎么做的呢？是一个比较传统的方案：先重定向到一个集中认证服务，登录完之后返回后台服务所在的域名，通过后台服务与认证服务交互，确认用户的登录情况，记录用户的身份，设置session，之后用cookie来识别用户的登录情况。</p>
<p>这部分其实与我的前端App没什么关系，因为不管是认证服务还是后台服务都是已经写好在运行的，我只要在访问后台服务的时候捕捉错误信息，正常跳转到认证服务，等待后台服务把用户重定向回来就行，因此与我来说看上去并没有什么关系。</p>
<p>然而问题在于，运行环境的服务器不由我管理，我也不愿意在运行环境下调试，因此我在自己的VPS和域名下部署了一套<a href="https://iptv.huiyiqun.me/">staging环境</a>用于线上测试，自己开发则在本机用localhost开发，拜托运行的老师在nginx里加了CORS的HTTP headers，一切挺顺利，看上去也很合理，然而在折腾cookie的时候却出了问题。</p>
<h1>兴起</h1>
<p>虽然没有什么必须要用<a href="https://fetch.spec.whatwg.org/">Fetch API</a>的理由，但是本着新东西要体验一下的原则，这个项目里还是用了<code>fetch</code>来替代<code>xhr</code>。
上面说了，认证系统是靠cookie来识别用户身份的，那么我必须保证发给后端的请求里要带上cookie，然而跨域请求显然是不会带上cookie的。
简单搜索了一下，找到了<a href="https://fetch.spec.whatwg.org/#cors-protocol-and-credentials">这个</a>，简单明了。
于是加上<code>credentials</code>这个参数，结果chrome上app跑起来，用户请求被重定向到了认证服务，什么鬼。翻了一下调试工具，发现访问后台的时候没有带cookie，直接用浏览器打开后台url，却能正常访问，oookie什么都不少。</p>
<p>这时候我就开始郁闷了：咦，spec理解错了？</p>
<p>于是乎，我开始认真地看了<a href="https://github.github.io/fetch/">github的fetch polyfill文档</a>，好像没差什么呀。
接着是<a href="https://developer.mozilla.org/en-US/docs/Web/API/Fetch_API/Using_Fetch">MDN</a>以及<a href="https://developers.google.com/web/updates/2015/03/introduction-to-fetch">Google Developers</a>，依然看不出来自己的调用方式有什么问题。</p>
<p>于是我开始脑洞大开，难道</p>
<blockquote>
<p>To cause browsers to send a request with credentials included.</p>
</blockquote>
<p>是指把源domain的credentials带上？那岂不是密码满天飞？</p>
<p>这时我依稀记起了polyfill的文档里提到了<code>credentials</code>为<code>same-origin</code>时行为和<code>xhr</code>是一致的，于是我觉得有必要复习一下<code>xhr</code>的行为。</p>
<p>于是重新看了<a href="https://developer.mozilla.org/en-US/docs/Web/API/XMLHttpRequest/withCredentials">MDN</a>，以及<a href="https://quickleft.com/blog/cookies-with-my-cors/">这篇博客</a>。
结论是自己的理解没有问题。</p>
<h1>发展</h1>
<p>这个时候我已经一头雾水了，出错其实不可怕，可怕的是出错了居然没有错误信息。
这就像你写了个<code>int x = 1</code>，编译运行发现<code>x</code>里存了个<code>0</code>，开了所有warning还是什么报警都没有。</p>
<p>于是我觉得编译器也不能相信了：</p>
<p>难道是chrome的实现有问题？由于特性新，我一直非常喜欢在chrome上写前端，要是特性实现有问题，那实在太可怕了，而且搜了半天都没见着issue，实在不可理解。</p>
<p>难道是服务器端给的headers有问题，导致CORS实际上并没有生效？或者只是部分生效？然而没看出什么问题。</p>
<p>难道是我又手贱把单词敲错了？之前因为手贱坑自己的事情并不少见。</p>
<p>于是我打开<a href="https://httpbin.org">httpbin</a>，开始各种尝试（不得不说，httpbin确实挺好用的，想要的东西基本都有，而且API简单，返回的结果里还带了很标准的CORS headers，很适合用来尝试一些东西）。</p>
<p>把<code>fetch</code>换成<code>xhr</code>，也没带cookie；反复对比和增删HTTP headers，始终没效果；把标准里的样例直接copy进来，以防自己敲错，依然未果。就这样，我大概从下午两三点一直折腾到了晚上十二点，精疲力尽。</p>
<h1>高潮</h1>
<p>当我都快睡着的时候，一时兴起，准备装个chrome-dev试试，安装的过程中无事，打开了尘封多年的firefox，在console里敲了几段快背下来的测试代码，结果。cookie带上了。</p>
<p>啥？chrome实现有bug？正好chrome-dev装好了，赶紧在chrome-dev里试了一下，依然没有带上cookie。这时候思路开始清晰了，在chrome里开了guest用户，把自己的所有配置都禁掉，一测试，cookie带上了。</p>
<p>我此时头都炸了，哪个傻逼插件坑了我半天！打开扩展列表，把可疑的扩展都禁掉，再试了一次，发现还是不行。打开设置，搜了一下cookie，在content settings里找到了一个打着勾的<code>Block third-party cookies and site data</code>，发现自己完全看不懂是什么意思。尝试禁用，这次终于好了。果然最后坑自己的傻逼通常都是自己。</p>
<p>这时才依稀想起，几年前Google似乎是问了我一下，要不要禁用什么什么cookie，避免被追踪，当时糊涂地点了是。</p>
<h1>总结</h1>
<ol>
<li>自己还是太年轻，换浏览器测试这样的事情都没想到；</li>
<li>测试的时候最好还是别用自己平常用的浏览器，有些上古时期加的玄学配置容易忘记，用干净的浏览器比较好；</li>
<li>遇到事情还是不能急，有些问题只要仔细分析一下，是可以不动手就找到一些蛛丝马迹的；</li>
<li>解决问题要讲究效率。</li>
</ol>
<h1>正文</h1>
<p>好，上面都是扯淡，看黑板。</p>
<p>如果你要让自己的CORS里带上cookie，完整的步骤是这样的：</p>
<ol>
<li>服务器端需要加一些headers，以nginx为例，建议用如下配置：</li>
</ol>
<div class="highlight"><pre><span></span><span class="k">add_header</span> <span class="s">Access-Control-Allow-Origin</span> <span class="nv">$http_origin</span> <span class="s">always</span><span class="p">;</span>
<span class="k">add_header</span> <span class="s">Access-Control-Allow-Credentials</span> <span class="s">true</span> <span class="s">always</span><span class="p">;</span>
</pre></div>


<p>如果想看实例，建议看<code>httpbin</code>的。</p>
<ol>
<li>客户端需要加一些参数，比如如果是<code>xhr</code>需要设<code>xhr.withCredentials</code>为true，如果是<code>fetch</code>需要设<code>credentials</code>为<code>include</code>。</li>
<li>确保用户的浏览器没有开<code>Block third-party cookies</code>这个选项，或者已经把你的站点加入白名单，这个可以提示用户自己去改。</li>
</ol>
<p>这篇博客就这么点，晚安。</p>
  </div>
  <div class="tag-cloud">
    <p>
    </p>
  </div>




<div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = 'huiyiqun';
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>
        Please enable JavaScript to view comments.

</noscript>
</article>

    <footer>
<p>&copy; Hui Yiqun 2017</p>
<p>    Powered by <a href="http://getpelican.com" target="_blank">Pelican</a> - <a href="https://github.com/alexandrevicenzi/flex" target="_blank">Flex</a> theme by <a href="http://alexandrevicenzi.com" target="_blank">Alexandre Vicenzi</a>
</p>    </footer>
  </main>

<!-- Google Analytics -->
<script type="text/javascript">
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-89649249-1', 'auto');
  ga('send', 'pageview');
</script>
<!-- End Google Analytics -->



<script type="application/ld+json">
{
  "@context" : "http://schema.org",
  "@type" : "Blog",
  "name": " Notepad ",
  "url" : "../../..",
  "image": "https://secure.gravatar.com/avatar/e96680ba97e70a013f818edde6753ca8?s=120",
  "description": ""
}
</script>
</body>
</html>